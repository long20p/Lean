name: Deploy to Azure Container Instances

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
     - prod
      location:
        description: 'Azure region'
      required: false
 default: 'eastus'

env:
  AZURE_LOCATION: eastus

jobs:
  # Validation job - runs on all PR and pushes
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
 - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
 uses: azure/login@v1
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

- name: Setup Bicep
 run: az bicep install

      - name: Validate Bicep templates
        run: |
  az deployment sub validate \
            --location ${{ env.AZURE_LOCATION }} \
 --template-file Deployment/main.bicep \
   --parameters Deployment/parameters/parameters.dev.json

  # Build job - builds the Docker image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Lean Engine
    run: dotnet build --configuration Release

  - name: Build Docker image
 uses: docker/build-push-action@v5
      with:
 context: .
          file: ./DockerfileNew
          push: false
   tags: lean-custom:${{ github.sha }}
       build-args: |
            CONFIGURATION=Release
cache-from: type=gha
        cache-to: type=gha,mode=max

  # Deploy to development
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
     with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        id: deploy
        uses: azure/arm-deploy@v1
 with:
          scope: subscription
       subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
    template: Deployment/main.bicep
          parameters: Deployment/parameters/parameters.dev.json
          deploymentName: lean-dev-${{ github.run_number }}

      - name: Build and Push Docker Image
   run: |
          az acr login --name ${{ steps.deploy.outputs.containerRegistryName }}
          docker build -f DockerfileNew -t ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:latest --build-arg CONFIGURATION=Release .
          docker push ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:latest

      - name: Restart Container
 run: |
    az container restart \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
        --name ${{ steps.deploy.outputs.containerInstanceName }}

  # Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
  needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  environment:
      name: staging
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        id: deploy
      uses: azure/arm-deploy@v1
        with:
     scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
region: ${{ env.AZURE_LOCATION }}
        template: Deployment/main.bicep
          parameters: Deployment/parameters/parameters.staging.json
          deploymentName: lean-staging-${{ github.run_number }}

      - name: Build and Push Docker Image
     run: |
          az acr login --name ${{ steps.deploy.outputs.containerRegistryName }}
    docker build -f DockerfileNew -t ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:staging --build-arg CONFIGURATION=Release .
  docker push ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:staging

      - name: Restart Container
        run: |
     az container restart \
          --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
        --name ${{ steps.deploy.outputs.containerInstanceName }}

  # Deploy to production (manual approval required)
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment:
      name: production
      url: https://portal.azure.com
  steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
   with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        id: deploy
        uses: azure/arm-deploy@v1
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ github.event.inputs.location || env.AZURE_LOCATION }}
          template: Deployment/main.bicep
          parameters: Deployment/parameters/parameters.prod.json
          deploymentName: lean-prod-${{ github.run_number }}

  - name: Build and Push Docker Image
        run: |
          az acr login --name ${{ steps.deploy.outputs.containerRegistryName }}
    docker build -f DockerfileNew -t ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:prod --build-arg CONFIGURATION=Release .
          docker push ${{ steps.deploy.outputs.containerRegistryLoginServer }}/lean-custom:prod

      - name: Restart Container
     run: |
          az container restart \
     --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --name ${{ steps.deploy.outputs.containerInstanceName }}

      - name: Verify Deployment
        run: |
          az container logs \
       --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --name ${{ steps.deploy.outputs.containerInstanceName }} \
            --tail 50
